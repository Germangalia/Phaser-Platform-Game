<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hello World Phaser</title>
    <style>
        body{
            padding: 0;
            margin: 0;
        }

        canvas{
            margin: 0 auto;
        }
    </style>
</head>
<body>

<script src="./node_modules/phaser/dist/phaser.js"></script>
<script type="text/javascript">

    var playState = {


        preload: function() {
            this.game.load.image('sky', 'assets/sky.png');
            this.game.load.image('ground', 'assets/platform.png');
            this.game.load.image('star', 'assets/star.png');
            this.game.load.image('tiles', 'assets/forest.png');
            this.game.load.spritesheet('dude', 'assets/dude.png', 32, 48);

            this.game.load.spritesheet('enemy', 'assets/baddie.png', 32, 48);

            this.game.load.image('live', 'assets/firstaid.png');

            game.load.image('bullet', 'assets/shoot.png');

            this.game.load.tilemap('tilemap', 'assets/forest.json', null, Phaser.Tilemap.TILED_JSON);
            this.game.load.image('Forest', 'assets/FreeTileset/png/BG/BG.png');
            this.game.load.image('Platforms', 'assets/FreeTileset/png/Tiles/1.png');
            this.game.load.image('Platforms2', 'assets/FreeTileset/png/Tiles/3.png');
            this.game.load.image('Stone', 'assets/FreeTileset/png/Object/Stone.png');
            this.game.load.image('Tree_2', 'assets/FreeTileset/png/Object/Tree_2.png');

            this.game.load.audio('dead', ['assets/dead.wav', 'assets/dead.mp3']);
            this.game.load.audio('dust', ['assets/dust.wav', 'assets/dust.mp3']);
            this.game.load.audio('jump', ['assets/jump.wav', 'assets/jump.mp3']);
            this.game.load.audio('coin', ['assets/coin.wav', 'assets/coin.mp3']);
            this.game.load.audio('music', ['assets/musicgame.mp3']);

            this.player;
            this.enemy;
            this.platforms;
            this.cursors;
            this.stars;
            this.score = 0;
            this.scoreText;

            this.max = 0;
            this.front_emitter;
            this.mid_emitter;
            this.back_emitter;
            this.update_interval = 4 * 60;
            this.i = 0;

            this.bullets;

            this.fireRate = 100;
            this.nextFire = 0;
        },

        create: function() {
            //Added physics
            this.game.physics.startSystem(Phaser.Physics.ARCADE);
            //Added background and platforms
            //this.game.add.sprite(0, 0, 'sky');
            this.map = this.game.add.tilemap('tilemap');
            this.map.addTilesetImage('Forest');
            this.map.addTilesetImage('Platforms');
            this.map.addTilesetImage('Platforms2');
            this.map.addTilesetImage('Stone');
            this.map.addTilesetImage('Tree_2');
            //Add Layers for platforms and background
            this.backgroundLayer = this.map.createLayer('Background');
            this.platformsLayer = this.map.createLayer('Platforms');
            //Add collision to platforms
            this.map.setCollisionBetween(1, 2000, true, 'Platforms');
            //Change map size
            this.backgroundLayer.resizeWorld();

            //Added sounds
            //this.game.sound.mute = true;
            this.music = this.game.add.audio('music', 0.5);
            this.music.play();
            this.deadSound = this.game.add.audio('dead', 0.1);
            this.jumpSound = this.game.add.audio('jump', 0.1);
            this.dustSound = this.game.add.audio('dust', 0.1);
            this.coinSound = this.game.add.audio('coin', 0.1);

            //Added player and enable pysics
            this.player = game.add.sprite(1, this.game.world.height - 450, 'dude');
            this.game.physics.arcade.enable(this.player);

            //Camera
            this.game.camera.follow(this.player);

            //  Player physics properties. Give the little guy a slight bounce.
            this.player.body.bounce.y = 0.2;
            this.player.body.gravity.y = 300;
            this.player.body.collideWorldBounds = true;
            //  Our two animations, walking left and right.
            this.player.animations.add('left', [0, 1, 2, 3], 10, true);
            this.player.animations.add('right', [5, 6, 7, 8], 10, true);


            //Added stars
            this.addStars();

            //Print lives score
            this.addLives();

            //Player shoot
            this.createBullets();

            //  The score
            this.scoreText = this.game.add.text(16, 16, 'score: 0', { fontSize: '32px', fill: '#000' });
            this.scoreText.fixedToCamera = true;

            //  Our controls.
            this.cursors = this.game.input.keyboard.createCursorKeys();
        },

        update: function() {

            this.game.physics.arcade.collide(this.player, this.platformsLayer);
            this.game.physics.arcade.collide(this.stars, this.platformsLayer);
            //  Checks to see if the player overlaps with any of the stars, if he does call the collectStar function
            this.game.physics.arcade.overlap(this.player, this.stars, this.collectStar, null, this);
            //  Reset the players velocity (movement)
            this.player.body.velocity.x = 0;
            if (this.cursors.left.isDown)
            {
                //  Move to the left
                this.player.body.velocity.x = -150;
                this.player.animations.play('left');
            }
            else if (this.cursors.right.isDown)
            {
                //  Move to the right
                this.player.body.velocity.x = 150;
                this.player.animations.play('right');
            }
            else
            {
                //  Stand still
                this.player.animations.stop();
                this.player.frame = 4;
            }
            //  Allow the player to jump if they are touching the ground.
            if (this.cursors.up.isDown )
            {
                this.game.sound.mute = false;
                //Only jamp in floor
                if (this.player.body.onFloor()){
                    this.player.body.velocity.y = -350;
                    this.jumpSound.play();
                }

            }
            //Shoot a player weapon
            if (game.input.activePointer.isDown)
            {
                this.fire();
            }

            this.inputs();
        },

        inputs: function() {
        },

        addStars: function(){
            this.stars = this.game.add.group();
            //  We will enable physics for any star that is created in this group
            this.stars.enableBody = true;
            this.starsNum = 30;
            for (var i = 0; i < this.starsNum; i++)
            {
                //  Create a star inside of the 'stars' group
                this.star = this.stars.create(i * 200, 0, 'star');
                //  Let gravity do its thing
                this.star.body.gravity.y = 100;
                //  This just gives each star a slightly random bounce value
                this.star.body.bounce.y = 0.7 + Math.random() * 0.2;
            }
        },


        collectStar: function (player, star) {
            this.game.sound.mute = false;
            // Removes the star from the screen with tween
            this.game.sound.mute = false;
            star.body.enable = false;
            game.add.tween(star.scale).to({x:0}, 150).start();
            game.add.tween(star).to({y:150}, 150).start();
            this.coinSound.play();

            //  Add and update the score
            this.score += 10;
            this.scoreText.text = 'Score: ' + this.score;
            this.coinSound.play();
        },

        addLives: function(){
            this.playerDead = false;
            this.lives = 3;
            this.remainingLives = game.add.group();
            this.livesText = this.game.add.text(16, 60, 'Lives : ', { font: '34px', fill: '#fff' });
            this.firstAidNum = 3;
            for (var i = 0; i < this.firstAidNum; i++)
            {
                this.firstaid = this.remainingLives.create(35 + (50 * i), 70, 'live');
                this.firstaid.anchor.setTo(0.5, 0.5);
                this.firstaid.alpha = 0.4;
            }
            this.livesText.fixedToCamera = true;
            this.remainingLives.fixedToCamera = true;
        },

        createBullets: function(){
            this.bullets = game.add.group();
            this.bullets.enableBody = true;
            this.bullets.physicsBodyType = Phaser.Physics.ARCADE;

            this.bullets.createMultiple(50, 'bullet');
//            this.bullets.setAll('checkWorldBounds', true);
//            this.bullets.setAll('outOfBoundsKill', true);
        },

        fire: function(){
            if (game.time.now > this.nextFire && this.bullets.countDead() > 0)
            {
                this.nextFire = game.time.now + this.fireRate;

                this.bullet = this.bullets.getFirstDead();

                this.bullet.reset(this.player.x + 10, this.player.y + 30 );

                game.physics.arcade.moveToPointer(this.bullet, 300);
            }
        }

    };

    var game = new Phaser.Game(1000, 320, Phaser.AUTO, '');

    game.state.add('play', playState);
    game.state.start('play');


</script>
</body>
</html>